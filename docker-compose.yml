version: '3.8'

services:
  amazon-price-tracker:
    build: .
    container_name: amazon-price-tracker
    restart: unless-stopped
    volumes:
      # Mount persistent data directory
      - ./data-persistent:/data
      # Mount config file for easy configuration updates
      - ./config.env:/usr/src/app/config.env:ro
      # Mount tmpfs for temporary files to reduce disk I/O
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 512M
    environment:
      - DATA_DIR=/data
      # Python memory management (Chrome variables removed - Amazon uses requests only)
      - MALLOC_ARENA_MAX=2
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    networks:
      - price-tracker-network
    # Optimized resource limits (Chrome removed - Amazon uses requests only)
    deploy:
      resources:
        limits:
          memory: 512M  # Reduced since no Chrome needed
          cpus: '1.0'
        reservations:
          memory: 256M  # Reduced baseline
          cpus: '0.25'
    # Note: shm_size removed since Chrome is not used
    # Enhanced healthcheck
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python.*main.py"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 2m
    # Logging configuration to prevent log buildup
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

networks:
  price-tracker-network:
    driver: bridge

volumes:
  # Named volume for data persistence (alternative to bind mount)
  price-tracker-data:
    driver: local


