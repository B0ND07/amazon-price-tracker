version: '3.8'

services:
  amazon-price-tracker:
    build: .
    container_name: amazon-price-tracker
    restart: unless-stopped
    volumes:
      # Mount persistent data directory
      - ./data-persistent:/data
      # Mount config file for easy configuration updates
      - ./config.env:/usr/src/app/config.env:ro
      # Mount tmpfs for temporary files to reduce disk I/O
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 512M
    environment:
      - DATA_DIR=/data
      # Python and Chrome memory management
      - MALLOC_ARENA_MAX=2
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    networks:
      - price-tracker-network
    # Optimized resource limits for Selenium (Amazon + Flipkart)
    deploy:
      resources:
        limits:
          memory: 800M  # Increased for Chrome/Selenium stability
          cpus: '1.0'
        reservations:
          memory: 400M  # Baseline for stable operation
          cpus: '0.25'
    # Shared memory for Chrome (prevents crashes)
    shm_size: '512m'
    # Enhanced healthcheck
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python.*main.py"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 2m
    # Logging configuration to prevent log buildup
    logging:
      driver: "json-file"
      options:
        max-size: "50m"  # Reduced for disk space conservation
        max-file: "2"    # Keep only 2 log files

networks:
  price-tracker-network:
    driver: bridge

volumes:
  # Named volume for data persistence (alternative to bind mount)
  price-tracker-data:
    driver: local


